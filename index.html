<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>sload</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1pbmZpbml0eS1pY29uIGx1Y2lkZS1pbmZpbml0eSI+PHBhdGggZD0iTTYgMTZjNSAwIDctOCAxMi04YTQgNCAwIDAgMSAwIDhjLTUgMC03LTgtMTItOGE0IDQgMCAxIDAgMCA4Ii8+PC9zdmc+" media="(prefers-color-scheme: light)">
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1pbmZpbml0eS1pY29uIGx1Y2lkZS1pbmZpbml0eSI+PHBhdGggZD0iTTYgMTZjNSAwIDctOCAxMi04YTQgNCAwIDAgMSAwIDhjLTUgMC03LTgtMTItOGE0IDQgMCAxIDAgMCA4Ii8+PC9zdmc+" media="(prefers-color-scheme: dark)">
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: monospace;
      padding: 30px;
      max-width: 800px;
      margin: auto;
    }
    label, input, button, select {
      font-family: inherit;
      margin-right: 10px;
      margin-top: 8px;
    }
    input, select {
      padding: 6px;
      background: #222;
      border: 1px solid #444;
      color: #fff;
      width: 130px;
    }
    input[type="text"] {
      width: 60%;
    }
    button {
      padding: 8px 16px;
      background: #222;
      border: 1px solid #444;
      color: #fff;
      cursor: pointer;
      margin-top: 10px;
    }
    .blue { color: #00afff; }
    .green { color: #00ff88; }
    .red { color: #ff5555; }
    .yellow { color: #ffff55; }
    pre {
      margin-top: 20px;
      padding: 20px;
      white-space: pre-wrap;
    }
    #progressBar {
      font-weight: bold;
      color: #00afff;
    }

  #customAlert {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #222;
    color: #eee;
    border: 1px solid #444;
    padding: 15px 25px;
    font-family: monospace;
    font-size: 16px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 15px;
    max-width: 300px;
  }
  #customAlert.show {
    opacity: 1;
    pointer-events: auto;
  }

.checkbox-container {
  display: inline-block;
  position: relative;
  user-select: none;
}

#noCors {
  display: none; /* ·∫©n checkbox g·ªëc */
}

/* Label l√†m th√†nh n√∫t b·∫•m */
.toggle-label {
  display: inline-block;
  padding: 6px 20px;
  border: 1px solid #444;
  background-color: #222;
  color: #eee;
  font-family: monospace;
  font-size: 16px;
  cursor: pointer;
  width: 60px;
  text-align: center;
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* Text m·∫∑c ƒë·ªãnh l√† NO */
.toggle-text::before {
  content: "No";
}

/* Khi checkbox checked, ƒë·ªïi text th√†nh YES v√† style kh√°c */
#noCors:checked + .toggle-label {
  background-color: #00afff;
  color: #111;
}

#noCors:checked + .toggle-label .toggle-text::before {
  content: "Yes";
}

/* ·∫®n m≈©i t√™n m·∫∑c ƒë·ªãnh tr√™n select v√† input type="number" */
select::-ms-expand {
    display: none;
}
select {
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23b0b0b0%22%20d%3D%22M287%20197.8L154.4%2065.2c-4.4-4.4-11.4-4.4-15.8%200L5.4%20197.8c-4.4%204.4-4.4%2011.4%200%2015.8l15.8%2015.8c4.4%204.4%2011.4%204.4%2015.8%200L146.5%20121l111.4%20111.4c4.4%204.4%2011.4%204.4%2015.8%200l15.8-15.8c4.4-4.4%204.4-11.4%200-15.8z%22%2F%3E%3C%2Fsvg%3E');
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 12px;
}


input[type="number"]::-webkit-inner-spin-button, 
input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
input[type="number"] {
    -moz-appearance: textfield;
}


/* Ki·ªÉu d√°ng cho c√°c tr∆∞·ªùng input v√† select */
select, input[type="number"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}
  </style>
  <style>
    body { background:#111; color:#eee; font-family: monospace; padding:20px; max-width:900px; margin:auto; }
    label,input,button,select,textarea { font-family:inherit; margin:6px 10px 6px 0; }
    input,select,textarea { padding:6px; background:#222; border:1px solid #444; color:#fff; }
    input[type="text"]{ width:60%; }
    input[type="number"]{ width:100px; }
    button{ padding:8px 12px; background:#222; border:1px solid #444; color:#fff; cursor:pointer; }
    .blue{ color:#00afff } .green{ color:#00ff88 } .red{ color:#ff5555 } .yellow{ color:#ffff55 }
    pre{ margin-top:12px; padding:14px; white-space:pre-wrap; background:#0c0c0c; border:1px solid #222; }
    #customAlert{ position:fixed; top:20px; right:20px; background:#222; color:#eee; padding:12px 16px; border:1px solid #444; opacity:0; transition:opacity .25s; pointer-events:none; }
    #customAlert.show{ opacity:1; pointer-events:auto; }
    .small { font-size:13px; color:#bbb; }
  </style>
</head>
<body>
  <div id="customAlert" role="alert" aria-live="assertive"><span id="alertMessage"></span></div>

  <h2 class="blue">sload</h2>
  <p class="small">Ch·ªâ d√πng cho ki·ªÉm th·ª≠ h·ª£p ph√°p (m√¥i tr∆∞·ªùng staging ho·∫∑c m·ª•c ti√™u b·∫°n s·ªü h·ªØu / ƒë∆∞·ª£c ph√©p). C√¥ng c·ª• ch·∫°y trong tr√¨nh duy·ªát v√† gi·ªõi h·∫°n theo c·∫•u h√¨nh.</p>

  <div>
    <label for="url">üéØ URL m·ª•c ti√™u:</label>
    <input type="text" id="url" value="https://httpbin.org/get" />
  </div>

  <div>
    <label for="rate">‚ö° Rate (req/s):</label>
    <input type="number" id="rate" value="2" min="1" />
    <label for="threads">üîß Threads (concurrency):</label>
    <input type="number" id="threads" value="4" min="1" />
    <label for="duration">‚è≥ Duration (s):</label>
    <input type="number" id="duration" value="30" min="1" />
  </div>

  <div>
    <label for="method">üìù Method:</label>
    <select id="method"><option>GET</option><option>POST</option></select>

    <label style="margin-left:10px;">
<div class="checkbox-container">
  <input type="checkbox" id="noCors" />
  <label for="noCors" class="toggle-label">nocors
    <span class="toggle-text"></span>
  </label>
</div>
    </label>
  </div>

  <div style="margin-top:8px;">
    <button id="startBtn">B·∫Øt ƒë·∫ßu</button>
    <button id="stopBtn">D·ª´ng</button>
    <button id="exportBtn">Xu·∫•t CSV</button>
    <span id="currentUrl" class="blue" style="margin-left:12px;"></span>
  </div>

  <pre id="output"></pre>

<script>
/*
  Safe load tester (browser-based)
  - Implements token-bucket scheduler to match desired rate (req/s)
  - Limits concurrency to `threads`
  - Measures latency (ms) per request (when possible)
  - When no-cors is enabled, response details are not available; we count totals but not success/fail accurately
*/

const alertEl = document.getElementById('customAlert');
const alertMessage = document.getElementById('alertMessage');
function showAlert(msg, ms=3000){ alertMessage.textContent = msg; alertEl.classList.add('show'); setTimeout(()=>alertEl.classList.remove('show'), ms); }

let running = false;
let state = null;

document.getElementById('startBtn').addEventListener('click', start);
document.getElementById('stopBtn').addEventListener('click', stop);
document.getElementById('exportBtn').addEventListener('click', exportCSV);

function nowMs(){ return (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now(); }

function percentile(arr, p){
  if (!arr.length) return 0;
  const sorted = Array.from(arr).sort((a,b)=>a-b);
  const idx = (p/100) * (sorted.length - 1);
  if (Number.isInteger(idx)) return sorted[idx];
  const lo = Math.floor(idx), hi = Math.ceil(idx);
  return sorted[lo] + (sorted[hi]-sorted[lo]) * (idx-lo);
}

function updateOutput(){
  const out = document.getElementById('output');
  const s = state;
  if (!s) { out.textContent = ''; return; }
  const elapsed = Math.floor((Date.now() - s.startTime)/1000);
  const remaining = Math.max(0, s.duration - elapsed);
  const successRate = s.total>0 ? ((s.success/s.total)*100).toFixed(1) : '0.0';
  const avgLatency = s.latencies.length ? (s.latencies.reduce((a,b)=>a+b,0)/s.latencies.length).toFixed(1) : 'n/a';
  const p50 = s.latencies.length ? percentile(s.latencies,50).toFixed(1) : 'n/a';
  const p95 = s.latencies.length ? percentile(s.latencies,95).toFixed(1) : 'n/a';
  const p99 = s.latencies.length ? percentile(s.latencies,99).toFixed(1) : 'n/a';

  // progress bar
  const barLen = 40;
  const pct = Math.min(elapsed / s.duration, 1);
  const done = Math.round(barLen * pct);
  const progress = '[' + '‚ñ†'.repeat(done) + '‚ñ°'.repeat(barLen - done) + ']';

  out.innerHTML = `
üéØ Target: ${s.url} : ${elapsed}s / ${s.duration}s
‚è≥ Remaining: ${remaining}s
üîß Config: Rate: ${s.rate}/s | Threads: ${s.threads} | Method: ${s.method} | no-cors: ${s.noCors ? 'YES (no response info)' : 'NO'}

üìä Statistics:
    ‚úÖ Success: ${s.success}
    ‚ùå Failed: ${s.failed}
    üìà Total: ${s.total}
    ‚ö° Rate (observed): ${(s.total / (elapsed || 1)).toFixed(2)} req/s
    ‚úì Success Rate: ${successRate}%

Latency (ms): avg ${avgLatency} | p50 ${p50} | p95 ${p95} | p99 ${p99}

${progress}
  `.trim();
}

function start(){
  if (running) { showAlert('ƒêang ch·∫°y r·ªìi ‚Äî d·ª´ng tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu l·∫°i',2000); return; }

  const url = (document.getElementById('url').value || '').trim();
  if (!url){ showAlert('Nh·∫≠p URL h·ª£p l·ªá'); return; }

  const rate = Math.max(1, Number(document.getElementById('rate').value) || 1);
  const threads = Math.max(1, Number(document.getElementById('threads').value) || 1);
  const duration = Math.max(1, Number(document.getElementById('duration').value) || 1);
  const method = document.getElementById('method').value;
  const noCors = document.getElementById('noCors').checked;

  // init state
  state = {
    url, rate, threads, duration, method, noCors,
    startTime: Date.now(),
    total:0, success:0, failed:0,
    latencies: [], // ms
    events: [], // optional detailed events for export
    tokens:0,
    ongoing:0,
    stopped:false
  };

  document.getElementById('currentUrl').textContent = 'üîó URL hi·ªán t·∫°i: ' + url;
  running = true;
  showAlert('B·∫Øt ƒë·∫ßu test', 1200);

  // Scheduler: add tokens at granularity = 100ms
  const tickMs = 100;
  const tokensPerTick = rate * (tickMs/1000);
  state.schedulerInterval = setInterval(()=> {
    if (!state || state.stopped) return;
    state.tokens += tokensPerTick;
    // try dispatch while tokens >=1 and concurrency allows
    while (state.tokens >= 1 - 1e-9 && state.ongoing < threads) {
      dispatchOne();
      state.tokens -= 1;
    }
    // update output frequently
    updateOutput();
    // stop after duration
    const elapsed = Math.floor((Date.now() - state.startTime)/1000);
    if (elapsed >= duration) { stop(); }
  }, tickMs);

  // also update output every 500ms for UI smoothness
  state.uiInterval = setInterval(updateOutput, 500);
}

function stop(){
  if (!running) return;
  if (!state) return;
  state.stopped = true;
  running = false;
  clearInterval(state.schedulerInterval);
  clearInterval(state.uiInterval);
  // We allow ongoing fetches to finish; after a small timeout, finalize
  setTimeout(()=> {
    updateOutput();
    showAlert('ƒê√£ d·ª´ng', 1500);
  }, 200);
}

function dispatchOne(){
  if (!state || state.stopped) return;
  state.ongoing++;
  const sstart = nowMs();
  const url = state.url;
  const opts = { method: state.method };
  if (!state.noCors) opts.mode = 'cors';
  else opts.mode = 'no-cors';

  // Attempt to add JSON body if POST
  if (state.method === 'POST') {
    opts.headers = { 'Content-Type': 'application/json' };
    try { opts.body = JSON.stringify({ ts: new Date().toISOString() }); } catch(e){}
  }

  // Note: in browsers you can't reliably set User-Agent; it is controlled by browser.
  fetch(url, opts).then(response => {
    const tend = nowMs();
    state.total++;
    state.ongoing--;
    // If no-cors, response is opaque and we can't read status/body
    if (state.noCors) {
      // we only know request was dispatched ‚Äî can't be sure about success
      // record latency only
      state.latencies.push(tend - sstart);
      state.events.push({ t: new Date().toISOString(), status: 'opaque', latency: tend - sstart });
    } else {
      // we can check status
      if (response.ok) {
        state.success++;
      } else {
        state.failed++;
      }
      state.latencies.push(tend - sstart);
      state.events.push({ t: new Date().toISOString(), status: response.status, latency: tend - sstart });
    }
  }).catch(err => {
    const tend = nowMs();
    state.total++;
    state.failed++;
    state.ongoing--;
    state.latencies.push(tend - sstart);
    state.events.push({ t: new Date().toISOString(), status: 'error', latency: tend - sstart, error: (err && err.message) ? err.message : String(err) });
  });
}

function exportCSV(){
  if (!state) { showAlert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t'); return; }
  // Create CSV of events
  const rows = [['timestamp','status','latency_ms','note']];
  for (const e of state.events) {
    rows.push([e.t || '', e.status || '', (e.latency||'').toString(), e.error ? e.error.replace(/\r?\n/g,' ') : '']);
  }
  const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sload_export_${(new Date()).toISOString().replace(/[:.]/g,'-')}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showAlert('ƒê√£ xu·∫•t CSV', 1600);
}

</script>
</body>
</html>
